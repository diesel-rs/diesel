#!/bin/sh
set -e

SCRIPTPATH=`dirname $0`

cd $SCRIPTPATH

set -a
if [ -f ../../.env ]; then . ../../.env; fi
DATABASE_URL=${PG_EXAMPLE_DATABASE_URL}
if [ -z "$BACKEND" ]; then
    export BACKEND="postgres"
fi
set +a

if [ -z "${BACKEND##*postgres*}" ]; then
  for dir in $(find . -maxdepth 1 -mindepth 1 -type d); do
    cd $dir
  
    if [ -d "migrations" ]; then
      ../../../bin/diesel database reset
    fi

    cargo test
    cd ..
  done
fi
