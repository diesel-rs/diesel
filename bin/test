#!/bin/sh
set -e
RUST_CHANNEL=$(multirust show-override | grep 'override toolchain' | awk '{print $4}')
BACKENDS=("postgres" "sqlite")

for BACKEND in $BACKENDS; do
  if [[ "$TRAVIS_RUST_VERSION" == nightly* ]]; then
    (cd diesel && cargo test --no-default-features --features "unstable chrono $BACKEND")
    (cd diesel_codegen && cargo test --no-default-features --features "nightly")
    (cd diesel_tests && cargo test --no-default-features --features "unstable $BACKEND")
    (cd diesel_compile_tests && cargo test)
  else
    (cd diesel && cargo test --no-default-features --features "chrono $BACKEND")
    (cd diesel_codegen && cargo test)
    (cd diesel_tests && cargo test --features $BACKEND)
  fi

  # CLI doesnt have any nightly specific features
  (cd diesel_cli && cargo test --no-default-features --features "$BACKEND")
done
