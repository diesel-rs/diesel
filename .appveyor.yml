version: 1.0.{build}

branches:
  only:
    - master
    - appveyor_nonsense

services:
  - postgresql95
  - mysql

cache:
  - C:\Users\appveyor\.cargo

install:
  - curl -fsS --retry 3 --retry-connrefused -o rustup-init.exe https://win.rustup.rs/
  # nightly is required for -Ctarget-feature=+crt-static until Rust 1.19
  - if not defined RUSTFLAGS rustup-init -yv --default-toolchain stable --default-host %target%
  - if defined RUSTFLAGS rustup-init -yv --default-toolchain nightly --default-host %target%
  - set PATH=%PATH%;%USERPROFILE%\.cargo\bin
  - rustc -vV
  - cargo -vV
  - if not defined VCPKG_DEFAULT_TRIPLET curl -fsS --retry 3 --retry-connrefused -o sqlite3.zip https://sqlite.org/2017/sqlite-dll-win64-x64-3160200.zip
  - if not defined VCPKG_DEFAULT_TRIPLET 7z e sqlite3.zip -y
  - if not defined VCPKG_DEFAULT_TRIPLET set SQLITE3_LIB_DIR=%APPVEYOR_BUILD_FOLDER%
  - if not defined VCPKG_DEFAULT_TRIPLET set PATH=%PATH%;%APPVEYOR_BUILD_FOLDER%
  - if not defined VCPKG_DEFAULT_TRIPLET "C:\Program Files (x86)\Microsoft Visual Studio 12.0\VC\bin\lib.exe" /def:sqlite3.def /OUT:sqlite3.lib /machine:x64

build: false

before_test:
  - SET PATH=%PATH%;C:\MinGW\bin
  # `cargo test` is broken with rustup. https://github.com/rust-lang/cargo/issues/3394
  - ps: $Env:PATH += ";" + (get-item (rustup which cargo)).Directory.FullName
  # setup pg databases
  - SET PATH=C:\Program Files\PostgreSQL\9.5\bin;%PATH%
  - createdb diesel_test
  # setup mysql databases
  - SET PATH=C:\Program Files\MySQL\MySQL Server 5.7\bin;C:\Program Files\MySQL\MySQL Server 5.7\lib;%PATH%
  - mysql -e "create database diesel_test; create database diesel_unit_test;" -uroot
  # install vcpkg if required
  - if defined VCPKG_DEFAULT_TRIPLET git clone https://github.com/Microsoft/vcpkg c:\projects\vcpkg
  - if defined VCPKG_DEFAULT_TRIPLET c:\projects\vcpkg\bootstrap-vcpkg.bat
  - if defined VCPKG_DEFAULT_TRIPLET set VCPKG_ROOT=c:\projects\vcpkg
  - if defined VCPKG_DEFAULT_TRIPLET %VCPKG_ROOT%\vcpkg.exe install %VCPKG_PKGS%

test_script:
  - cd diesel
  - cargo test --features "%backend% extras"
  - cd ../diesel_cli
  - cargo test --no-default-features --features "%backend%"
  - cd ../diesel_codegen
  - cargo test --features "%backend%"
  - cd ../diesel_tests
  - cargo test --features "%backend%"

environment:
  global:
    PGUSER: postgres
    PGPASSWORD: Password12!
    MYSQL_PWD: Password12!

  matrix:
    - target: x86_64-pc-windows-msvc
      backend: postgres
      PG_DATABASE_URL: postgres://postgres:Password12!@localhost/diesel_test
      PG_EXAMPLE_DATABASE_URL: postgres://postgres:Password12!@localhost/diesel_example
    - target: x86_64-pc-windows-msvc
      backend: sqlite
      SQLITE_DATABASE_URL: test.db
    - target: x86_64-pc-windows-msvc
      backend: mysql
      MYSQL_DATABASE_URL: mysql://root:Password12!@localhost:3306/diesel_test
      MYSQL_EXAMPLE_DATABASE_URL: mysql://root:Password12!@localhost:3306/diesel_example
      MYSQL_UNIT_TEST_DATABASE_URL: mysql://root:Password12!@localhost:3306/diesel_unit_test
      # Neither mysql_config or pkg-config work for this on Windows
      MYSQLCLIENT_LIB_DIR: C:\Program Files\MySQL\MySQL Server 5.7\lib
      RUST_TEST_THREADS: 1
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2013
    - target: x86_64-pc-windows-gnu
      backend: postgres
      PG_DATABASE_URL: postgres://postgres:Password12!@localhost/diesel_test
    - target: x86_64-pc-windows-gnu
      backend: sqlite
      SQLITE_DATABASE_URL: test.db
    - target: x86_64-pc-windows-gnu
      backend: mysql
      MYSQL_DATABASE_URL: mysql://root:Password12!@localhost:3306/diesel_test
      MYSQL_EXAMPLE_DATABASE_URL: mysql://root:Password12!@localhost:3306/diesel_example
      MYSQL_UNIT_TEST_DATABASE_URL: mysql://root:Password12!@localhost:3306/diesel_unit_test
      # Neither mysql_config or pkg-config work for this on Windows
      MYSQLCLIENT_LIB_DIR: C:\Program Files\MySQL\MySQL Server 5.7\lib
      RUST_TEST_THREADS: 1
      #
      # builds from vcpkg
      #
    - target: x86_64-pc-windows-msvc
      backend: postgres
      PG_DATABASE_URL: postgres://postgres:Password12!@localhost/diesel_test
      PG_EXAMPLE_DATABASE_URL: postgres://postgres:Password12!@localhost/diesel_example
      VCPKG_DEFAULT_TRIPLET: x64-windows-static
      VCPKG_PKGS: libpq
      RUSTFLAGS: -Ctarget-feature=+crt-static
    - target: x86_64-pc-windows-msvc
      backend: sqlite
      SQLITE_DATABASE_URL: test.db
      VCPKG_DEFAULT_TRIPLET: x64-windows-static
      VCPKG_PKGS: sqlite3
      RUSTFLAGS: -Ctarget-feature=+crt-static
    - target: x86_64-pc-windows-msvc
      backend: mysql
      MYSQL_DATABASE_URL: mysql://root:Password12!@localhost:3306/diesel_test
      MYSQL_EXAMPLE_DATABASE_URL: mysql://root:Password12!@localhost:3306/diesel_example
      MYSQL_UNIT_TEST_DATABASE_URL: mysql://root:Password12!@localhost:3306/diesel_unit_test
      RUST_TEST_THREADS: 1
      VCPKG_DEFAULT_TRIPLET: x64-windows-static
      VCPKG_PKGS: libmysql
      RUSTFLAGS: -Ctarget-feature=+crt-static
